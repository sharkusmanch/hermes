# ~/.zshrc for hermes toolbox

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

# ============================================================================
# HOMEBREW
# ============================================================================
if [[ -d "/home/linuxbrew/.linuxbrew" ]]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# ============================================================================
# ZSH OPTIONS
# ============================================================================
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt SHARE_HISTORY
setopt AUTO_CD
setopt CORRECT

HISTSIZE=10000
SAVEHIST=20000
HISTFILE=~/.zsh_history

# ============================================================================
# COMPLETION
# ============================================================================
autoload -Uz compinit
compinit

# kubectl completion
source <(kubectl completion zsh)

# helm completion
source <(helm completion zsh)

# flux completion
source <(flux completion zsh)

# ============================================================================
# ALIASES
# ============================================================================
alias ls='ls --color=auto'
alias grep='grep --color=auto'
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'
alias k='kubectl'
alias kgp='kubectl get pods'
alias kgs='kubectl get svc'
alias kga='kubectl get all'
alias watch='watch '

# Claude Code
alias cc='claude'
alias ccc='claude --continue'

# ============================================================================
# FZF
# ============================================================================
[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ] && source /usr/share/doc/fzf/examples/key-bindings.zsh
[ -f /usr/share/doc/fzf/examples/completion.zsh ] && source /usr/share/doc/fzf/examples/completion.zsh

# ============================================================================
# ATUIN - Shell History Sync
# ============================================================================
if command -v atuin &> /dev/null; then
    if [[ -f "$HOME/.config/atuin/config.toml" ]]; then
        eval "$(atuin init zsh)"
    else
        echo "Atuin not configured. Run 'atuin-setup' to configure."
    fi
fi

# Helper function to setup atuin on first run
atuin-setup() {
    local server="${1:-http://mnemosyne.toolbox.svc.cluster.local:8888}"

    mkdir -p ~/.config/atuin
    cat > ~/.config/atuin/config.toml << EOF
## Atuin Configuration
## See: https://docs.atuin.sh/configuration/config/

# Sync server address
sync_address = "${server}"

# Sync frequency
sync_frequency = "5m"

# Search mode: prefix, fulltext, fuzzy, skim
search_mode = "fuzzy"

# Filter mode: global, host, session, directory
filter_mode = "global"

# Style: auto, full, compact
style = "compact"

# Show help in UI
show_help = true

# Exit on Esc
exit_mode = "return-original"

# Store on enter (even if command fails)
enter_accept = true
EOF

    echo "Atuin config written to ~/.config/atuin/config.toml"
    echo ""
    echo "Now register or login:"
    echo "  New account:  atuin register -u <username> -e <email>"
    echo "  Existing:     atuin login -u <username>"
    echo ""
    echo "Then restart your shell or run: eval \"\$(atuin init zsh)\""
}

# ============================================================================
# KUBERNETES HELPERS
# ============================================================================

# Quick pod logs
klog() {
    kubectl logs -f "$@"
}

# Quick exec into pod
kexec() {
    kubectl exec -it "$1" -- "${2:-sh}"
}

# Get all resources in namespace
kall() {
    local ns="${1:-$(kubectl config view --minify -o jsonpath='{..namespace}')}"
    ns="${ns:-default}"
    kubectl api-resources --verbs=list --namespaced -o name | xargs -n1 kubectl get -n "$ns" --show-kind --ignore-not-found
}

# ============================================================================
# STARSHIP PROMPT
# ============================================================================
eval "$(starship init zsh)"
